# Microservices Logging - Request Flow Diagram

## Complete Request Flow with Logging

```
????????????????????????????????????????????????????????????????????????????
?                           CLIENT / API CONSUMER                          ?
????????????????????????????????????????????????????????????????????????????
                                 ?
                                 ? POST /api/orders
                                 ? Headers: X-Correlation-ID: abc-123
                                 ? Body: { customerId, items, ... }
                                 ?
                                 ?
??????????????????????????????????????????????????????????????????????????????
?                            ORDER SERVICE                                   ?
?                         (Kubernetes Pod)                                   ?
??????????????????????????????????????????????????????????????????????????????
?                                                                            ?
?  [1] CorrelationIdMiddleware                                               ?
?      ?? Receives/Generates: abc-123                                        ?
?      ?? Adds to Response Headers                                           ?
?      ?? Logs: "Request started: POST /api/orders"                          ?
?         {                                                                  ?
?           "CorrelationId": "abc-123",                                      ?
?           "ServiceName": "OrderService",                                   ?
?           "RequestPath": "/api/orders",                                    ?
?           "RequestMethod": "POST"                                          ?
?         }                                                                  ?
?                                                                            ?
?  [2] OrdersController.Create()                                             ?
?      ?? Logs: "Creating order for customer CUST-123"                       ?
?         { "CorrelationId": "abc-123", "CustomerId": "CUST-123" }          ?
?                                                                            ?
?  [3] OrderBusinessService.CreateOrderAsync()                               ?
?      ?? Logs: "Creating order ORD-1234 - checking inventory for 1 items"  ?
?         { "CorrelationId": "abc-123", "OrderId": "ORD-1234" }             ?
?                                                                            ?
?  [4] InventoryServiceClient.CheckInventoryAsync()                          ?
?      ?? CorrelationIdDelegatingHandler adds header                         ?
?      ?? Logs: "Calling InventoryService to check inventory for PROD-1"    ?
?         { "CorrelationId": "abc-123", "ProductId": "PROD-1" }             ?
?                                                                            ?
??????????????????????????????????????????????????????????????????????????????
                                  ?
                                  ? POST /api/inventory/check
                                  ? Headers: X-Correlation-ID: abc-123
                                  ? Body: { productId: "PROD-1", quantity: 1 }
                                  ?
                                  ?
??????????????????????????????????????????????????????????????????????????????
?                          INVENTORY SERVICE                                 ?
?                         (Kubernetes Pod)                                   ?
??????????????????????????????????????????????????????????????????????????????
?                                                                            ?
?  [5] CorrelationIdMiddleware                                               ?
?      ?? Receives: abc-123 (from header)                                    ?
?      ?? Logs: "Request started: POST /api/inventory/check"                 ?
?         {                                                                  ?
?           "CorrelationId": "abc-123",                                      ?
?           "ServiceName": "InventoryService",                               ?
?           "RequestPath": "/api/inventory/check"                            ?
?         }                                                                  ?
?                                                                            ?
?  [6] InventoryController.CheckInventory()                                  ?
?      ?? Logs: "Checking inventory for product PROD-1, quantity: 1"        ?
?         { "CorrelationId": "abc-123", "ProductId": "PROD-1" }             ?
?                                                                            ?
?  [7] InventoryBusinessService.CheckInventory()                             ?
?      ?? Logs: "Checking inventory for product PROD-1"                      ?
?      ?? Logs: "Inventory check result: Available=true, InStock=50"        ?
?         {                                                                  ?
?           "CorrelationId": "abc-123",                                      ?
?           "ProductId": "PROD-1",                                           ?
?           "Available": true,                                               ?
?           "InStock": 50                                                    ?
?         }                                                                  ?
?                                                                            ?
?  [8] Returns: { available: true, availableQuantity: 50 }                   ?
?                                                                            ?
??????????????????????????????????????????????????????????????????????????????
                                  ?
                                  ? Response: 200 OK
                                  ? Headers: X-Correlation-ID: abc-123
                                  ?
                                  ?
??????????????????????????????????????????????????????????????????????????????
?                          ORDER SERVICE (continued)                         ?
??????????????????????????????????????????????????????????????????????????????
?                                                                            ?
?  [9] InventoryServiceClient receives response                              ?
?      ?? Logs: "InventoryService check completed: Available=true, 45ms"    ?
?         { "CorrelationId": "abc-123", "Duration": 45 }                    ?
?                                                                            ?
?  [10] InventoryServiceClient.ReserveInventoryAsync()                       ?
?       ?? Logs: "Calling InventoryService to reserve inventory"            ?
?                                                                            ?
??????????????????????????????????????????????????????????????????????????????
                                  ?
                                  ? POST /api/inventory/reserve
                                  ? Headers: X-Correlation-ID: abc-123
                                  ?
                                  ?
??????????????????????????????????????????????????????????????????????????????
?                     INVENTORY SERVICE (Reserve)                            ?
??????????????????????????????????????????????????????????????????????????????
?                                                                            ?
?  [11] InventoryBusinessService.ReserveInventory()                          ?
?       ?? Logs: "Reserving inventory for order ORD-1234"                    ?
?       ?? Updates: AvailableQuantity 50 ? 49                                ?
?       ?? Logs: "Inventory reserved: ReservationId=RES-xyz, Remaining=49"  ?
?          {                                                                 ?
?            "CorrelationId": "abc-123",                                     ?
?            "OrderId": "ORD-1234",                                          ?
?            "ReservationId": "RES-xyz",                                     ?
?            "Remaining": 49                                                 ?
?          }                                                                 ?
?                                                                            ?
??????????????????????????????????????????????????????????????????????????????
                                  ?
                                  ? Response: 200 OK
                                  ?
                                  ?
??????????????????????????????????????????????????????????????????????????????
?                     ORDER SERVICE (finalize)                               ?
??????????????????????????????????????????????????????????????????????????????
?                                                                            ?
?  [12] OrderBusinessService creates order                                   ?
?       ?? Logs: "Order ORD-1234 created successfully with 1 reservations"  ?
?          { "CorrelationId": "abc-123", "OrderId": "ORD-1234" }           ?
?                                                                            ?
?  [13] OrdersController returns                                             ?
?       ?? Logs: "Order ORD-1234 created successfully for CUST-123"         ?
?                                                                            ?
?  [14] CorrelationIdMiddleware                                              ?
?       ?? Logs: "Request completed: POST /api/orders - Status: 201, 250ms" ?
?          { "CorrelationId": "abc-123", "Duration": 250 }                  ?
?                                                                            ?
??????????????????????????????????????????????????????????????????????????????
                                  ?
                                  ? Response: 201 Created
                                  ? Headers: X-Correlation-ID: abc-123
                                  ? Body: { id: "ORD-1234", ... }
                                  ?
                                  ?
??????????????????????????????????????????????????????????????????????????????
?                                CLIENT                                      ?
??????????????????????????????????????????????????????????????????????????????


??????????????????????????????????????????????????????????????????????????????
?                           LOG COLLECTION FLOW                              ?
??????????????????????????????????????????????????????????????????????????????

All stdout logs from both services (JSON format)
                    ?
??????????????????????????????????????????????????????????????????????????????
?                        FLUENT BIT DAEMONSET                                ?
?                     (Runs on each Kubernetes node)                         ?
??????????????????????????????????????????????????????????????????????????????
?                                                                            ?
?  • Tails: /var/log/containers/*.log                                        ?
?  • Parses: JSON format                                                     ?
?  • Enriches with Kubernetes metadata:                                      ?
?    - k8s_pod_name: order-service-abc123                                    ?
?    - k8s_namespace_name: microservices                                     ?
?    - k8s_labels: {"app": "order-service"}                                  ?
?    - k8s_container_name: order-service                                     ?
?                                                                            ?
??????????????????????????????????????????????????????????????????????????????
                                  ?
                                  ? Ships to Elasticsearch
                                  ? Index: logs-microservices-2024.01.15
                                  ? Format: JSON with k8s metadata
                                  ?
                                  ?
??????????????????????????????????????????????????????????????????????????????
?                           ELASTICSEARCH                                    ?
?                         (Centralized Storage)                              ?
??????????????????????????????????????????????????????????????????????????????
?                                                                            ?
?  Index: logs-microservices-2024.01.15                                      ?
?                                                                            ?
?  Document Example:                                                         ?
?  {                                                                         ?
?    "@timestamp": "2024-01-15T10:30:45.123Z",                               ?
?    "Level": "Information",                                                 ?
?    "Message": "Order ORD-1234 created successfully",                       ?
?    "CorrelationId": "abc-123",                                             ?
?    "ServiceName": "OrderService",                                          ?
?    "OrderId": "ORD-1234",                                                  ?
?    "CustomerId": "CUST-123",                                               ?
?    "Duration": 250,                                                        ?
?    "k8s_pod_name": "order-service-7d8f9b-xyz",                             ?
?    "k8s_namespace_name": "microservices",                                  ?
?    "k8s_labels": {"app": "order-service", "version": "v1"}                 ?
?  }                                                                         ?
?                                                                            ?
??????????????????????????????????????????????????????????????????????????????
                                  ?
                                  ? Queries via REST API
                                  ?
                                  ?
??????????????????????????????????????????????????????????????????????????????
?                              KIBANA                                        ?
?                        (Visualization & Search)                            ?
??????????????????????????????????????????????????????????????????????????????
?                                                                            ?
?  Search Query: CorrelationId:"abc-123"                                     ?
?                                                                            ?
?  Results (Timeline View):                                                  ?
?  ???????????????????????????????????????????????????????????????????????  ?
?  10:30:45.100 [OrderService]      Request started: POST /api/orders       ?
?  10:30:45.105 [OrderService]      Creating order for customer CUST-123    ?
?  10:30:45.110 [OrderService]      Calling InventoryService for PROD-1     ?
?  10:30:45.120 [InventoryService]  Request started: POST /api/inventory    ?
?  10:30:45.125 [InventoryService]  Checking inventory for PROD-1           ?
?  10:30:45.140 [InventoryService]  Inventory available: 50 units           ?
?  10:30:45.145 [InventoryService]  Request completed: 200 OK, 25ms         ?
?  10:30:45.150 [OrderService]      InventoryService check completed: 45ms  ?
?  10:30:45.155 [OrderService]      Calling InventoryService to reserve     ?
?  10:30:45.165 [InventoryService]  Request started: POST /api/inventory    ?
?  10:30:45.170 [InventoryService]  Reserving inventory for ORD-1234        ?
?  10:30:45.190 [InventoryService]  Inventory reserved: RES-xyz, Remain=49  ?
?  10:30:45.195 [InventoryService]  Request completed: 200 OK, 30ms         ?
?  10:30:45.200 [OrderService]      Inventory reserved: ReservationId=xyz   ?
?  10:30:45.320 [OrderService]      Order ORD-1234 created successfully     ?
?  10:30:45.325 [OrderService]      Request completed: 201, 250ms           ?
?  ???????????????????????????????????????????????????????????????????????  ?
?                                                                            ?
?  ? Complete trace of request across 2 services                            ?
?  ? Total duration: 250ms                                                  ?
?  ? InventoryService calls: 2 (check + reserve)                            ?
?  ? All events linked by CorrelationId                                     ?
?                                                                            ?
??????????????????????????????????????????????????????????????????????????????
```

## Key Logging Points

### Entry Points (Where Correlation ID is Set)
1. **Client ? OrderService**: CorrelationIdMiddleware generates or receives ID
2. **OrderService ? InventoryService**: CorrelationIdDelegatingHandler adds header
3. **All downstream calls**: Same ID propagates automatically

### What Gets Logged (with CorrelationId)
- ? HTTP request start/end (middleware)
- ? Business operations (create order, check inventory)
- ? External service calls (duration, success/failure)
- ? Database operations (if added)
- ? Errors with full stack trace
- ? Performance metrics (duration, counts)

### Searchable in Kibana
```
# Single request trace
CorrelationId:"abc-123"

# Service-specific
CorrelationId:"abc-123" AND ServiceName:"OrderService"

# With errors
CorrelationId:"abc-123" AND Level:"Error"

# Slow operations
CorrelationId:"abc-123" AND Duration:>100
```

## Benefits Visualization

```
WITHOUT Correlation IDs:
???????????????  ???????????????
? Service A   ?  ? Service B   ?
? Log 1       ?  ? Log 5       ?
? Log 2       ?  ? Log 6       ?
? Log 3       ?  ? Log 7       ?
? Log 4       ?  ? Log 8       ?
???????????????  ???????????????
? Which logs belong together? Unknown!
? What called what? Hard to tell!
? Total duration? Manual calculation!

WITH Correlation IDs:
???????????????????????????????????
? CorrelationId: abc-123          ?
???????????????????????????????????
? Service A - Log 1  [10:30:45.1] ?
? Service A - Log 2  [10:30:45.2] ?
? Service B - Log 5  [10:30:45.3] ? ? Called by Service A
? Service B - Log 6  [10:30:45.4] ?
? Service A - Log 3  [10:30:45.5] ? ? After B responds
? Service A - Log 4  [10:30:45.6] ?
???????????????????????????????????
? All related logs grouped!
? Call flow visualized!
? Duration calculated automatically!
```

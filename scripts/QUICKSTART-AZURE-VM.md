# Azure VM ?? - ??????

## ????

### ?? PowerShell (Windows)

```powershell
# ????
.\scripts\deploy-to-azure-vm.ps1 -ResourceGroup "my-rg" -VmName "my-vm"

# ????
.\scripts\deploy-to-azure-vm.ps1 `
    -ResourceGroup "microservices-logging-rg" `
    -VmName "microservices-vm" `
    -Location "eastus" `
    -VmSize "Standard_D4s_v3" `
    -AdminUsername "azureuser"
```

### ?? Bash (Linux/macOS)

```bash
# ??????
chmod +x scripts/deploy-to-azure-vm.sh

# ????
./scripts/deploy-to-azure-vm.sh

# ???
./scripts/deploy-to-azure-vm.sh microservices-logging-rg microservices-vm eastus Standard_D4s_v3
```

## ????

?????????????

1. ? ?? Azure CLI ? Docker ??
2. ? ?? Azure ???
3. ? ?????????
4. ? ???????????????
5. ? ???? IP ??
6. ? ?? Ubuntu 22.04 ???
7. ? ?? Docker ??
8. ? ?????????? VM
9. ? ? VM ??? Docker ? k3s
10. ? ????????Elasticsearch, Kibana, Fluent Bit, Order Service?

## ????

- **???**: 15-20 ??
  - Azure ????: 5-8 ??
  - Docker ???????: 3-5 ??
  - VM ???????: 7-10 ??

## ????

?? **Standard_D4s_v3** (4 vCPUs, 16 GB RAM):
- **????**: ~$0.192/?? (~$140/?)
- **1 ???**: ~$0.088/?? (~$64/?) - ?? 54%
- **3 ???**: ~$0.061/?? (~$44/?) - ?? 68%

?? **Standard_B2ms** (2 vCPUs, 8 GB RAM, ????):
- **????**: ~$0.083/?? (~$60/?)

> ?? **??**: ???????????? VM ???????

## ????

??????????????

- **Kibana**: http://YOUR_VM_IP:5601
- **Order Service API**: http://YOUR_VM_IP:8080/swagger
- **????**: http://YOUR_VM_IP:8080/health

## ????

```bash
# SSH ? VM
ssh azureuser@YOUR_VM_IP

# ???? Pod
kubectl get pods -A

# ?????????
# NAMESPACE        NAME                            READY   STATUS    RESTARTS   AGE
# logging          elasticsearch-0                 1/1     Running   0          5m
# logging          kibana-xxxxx                    1/1     Running   0          4m
# logging          fluent-bit-xxxxx                1/1     Running   0          3m
# microservices    order-service-xxxxx             1/1     Running   0          2m

# ?? API
curl http://localhost:8080/health
```

## ??????

```bash
# ??????
curl -X POST http://YOUR_VM_IP:8080/api/orders \
  -H "Content-Type: application/json" \
  -d '{
    "customerId": "test-customer",
    "items": [{
      "productId": "product-1",
      "productName": "Test Product",
      "quantity": 2,
      "unitPrice": 99.99
    }],
    "totalAmount": 199.98
  }'

# ????
kubectl logs -n microservices -l app=order-service --tail=50
```

## ? Kibana ?????

1. ??????? http://YOUR_VM_IP:5601
2. ?? Kibana ???????????? 1-2 ???
3. ?????? **? > Management > Stack Management**
4. ?? **Index Management** ????
5. ?? **Index Patterns > Create index pattern**
6. ?? `fluent-bit-*` ??????
7. ?? `@timestamp` ??????
8. ?? **Create index pattern**
9. ?????? **? > Discover** ????

## ????

### Q: ????????

????????????
```bash
# ?? Azure ????
az vm show --resource-group <RG_NAME> --name <VM_NAME>

# ?? VM ??
az vm boot-diagnostics get-boot-log --resource-group <RG_NAME> --name <VM_NAME>
```

### Q: ?????????

```bash
# SSH ? VM
ssh azureuser@YOUR_VM_IP

# ??????
kubectl delete namespace microservices
kubectl delete namespace logging

# ????
cd ~/k8s
kubectl apply -f .
```

### Q: ?????????

```bash
# ?? Order Service ??
kubectl logs -n microservices -l app=order-service -f

# ?? Elasticsearch ??
kubectl logs -n logging statefulset/elasticsearch -f

# ?? Fluent Bit ??
kubectl logs -n logging daemonset/fluent-bit -f
```

### Q: ???????

?? Azure NSG ???
```bash
az network nsg rule list \
  --resource-group <RG_NAME> \
  --nsg-name <NSG_NAME> \
  --output table
```

### Q: ???? VM ??????

```bash
# ?? VM????? CPU????????
az vm deallocate --resource-group <RG_NAME> --name <VM_NAME>

# ?? VM
az vm start --resource-group <RG_NAME> --name <VM_NAME>
```

## ????

### ??? Kubernetes ??
```bash
ssh azureuser@YOUR_VM_IP
kubectl delete namespace microservices
kubectl delete namespace logging
```

### ?????? Azure ??
```bash
az group delete --name microservices-logging-rg --yes --no-wait
```

> ?? **??**: ????????????????????

## ???

- ?? ??????: [DEPLOYMENT-AZURE-VM.md](DEPLOYMENT-AZURE-VM.md)
- ?? ?? CI/CD: ?????????
- ?? ????: ?? Azure Monitor
- ?? ????: ?? HTTPS ???
- ?? ????: ????????

## ??

?????????
- [Azure VM ??](https://docs.microsoft.com/azure/virtual-machines/)
- [k3s ??](https://k3s.io/)
- [??????](ARCHITECTURE.md)
